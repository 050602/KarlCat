{"version":3,"file":"GateMain.js","sourceRoot":"","sources":["../../../src/servers/gate/GateMain.ts"],"names":[],"mappings":"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","sourcesContent":["import { BaseServerLogic } from \"../../components/BaseServerLogic\";\r\nimport { Session } from \"../../components/session\";\r\nimport LoginTable from \"../../database/LoginTable\";\r\nimport RoleTable from \"../../database/RoleTable\";\r\nimport { KalrEvent } from \"../../event/KalrEvent\";\r\nimport { lanlu } from \"../../proto/protobuf/proto.js.js\";\r\nimport { TSEventCenter } from \"../../utils/TSEventCenter\";\r\n\r\nexport default class GateMain extends BaseServerLogic {\r\n    public static SigletonInsName = \"GateMain\";\r\n    public static get Instance(): GateMain {\r\n        return super.getInstance(GateMain);\r\n    }\r\n    public initInstance(): void {\r\n        //接受前端服数据 ---注意，前端服只能接收到前端服的消息以及RPC消息\r\n        TSEventCenter.Instance.bind(KalrEvent.FrontendServerDoFuntion + \"100_1\", this, this.onLogin);\r\n        TSEventCenter.Instance.bind(KalrEvent.FrontendServerDoFuntion + \"100_2\", this, this.onExit);//退出登录\r\n        TSEventCenter.Instance.bind(KalrEvent.FrontendServerDoFuntion + \"100_3\", this, this.onEnterRole);//进入游戏\r\n    }\r\n\r\n\r\n    public destoryInstance(): void {\r\n        TSEventCenter.Instance.unbind(KalrEvent.FrontendServerDoFuntion + \"100_1\", this,);\r\n        TSEventCenter.Instance.unbind(KalrEvent.FrontendServerDoFuntion + \"100_2\", this,);//退出登录\r\n        TSEventCenter.Instance.unbind(KalrEvent.FrontendServerDoFuntion + \"100_3\", this,);//进入游戏\r\n    }\r\n\r\n    async onExit(msg: lanlu.IPt100_2_tos, session: Session, next: Function) {\r\n\r\n    }\r\n\r\n    async onEnterRole(msg: lanlu.IPt100_3_tos, session: Session, next: Function) {\r\n        let data: lanlu.IPt100_3_toc;\r\n        let role = await RoleTable.find(msg.roleId);\r\n        if (role != null) {\r\n            data = {\r\n                code: 1  // 错误码 0失败 1成功-加载场景 2登录太频繁 3IP黑名单 4帐号被禁 5账号在其他地方登陆 6封号 7买卖元宝封号 8不正当竞争封号 9状态不正常 10所有账号登陆都被禁止 11服务器维护\r\n            };\r\n        } else {\r\n            data = {\r\n                code: 1  // 错误码 0失败 1成功-加载场景 2登录太频繁 3IP黑名单 4帐号被禁 5账号在其他地方登陆 6封号 7买卖元宝封号 8不正当竞争封号 9状态不正常 10所有账号登陆都被禁止 11服务器维护\r\n            };\r\n        }\r\n        next(data);\r\n    }\r\n\r\n    async onLogin(msg: lanlu.IPt100_1_tos, session: Session, next: Function) {\r\n        let database = await LoginTable.find(msg.userName);\r\n\r\n        let data: lanlu.IPt100_1_toc;\r\n        if (!database) {\r\n            console.log(msg.userName, msg.passWord);\r\n            //完全找不到数据返回错误\r\n            //登录失败\r\n            data = {\r\n                serverId: -1,\r\n                serverTime: 0,\r\n                roleList: [],\r\n                code: 0  // 错误码 0失败 1成功-加载场景 2登录太频繁 3IP黑名单 4帐号被禁 5账号在其他地方登陆 6封号 7买卖元宝封号 8不正当竞争封号 9状态不正常 10所有账号登陆都被禁止 11服务器维护\r\n            };\r\n\r\n        } else if (database.password == msg.passWord) {\r\n            //登录成功\r\n            //分配一个服务器给玩家使用  此处经过一系列复杂的逻辑后，给玩家分配一个没那么忙的服务器\r\n\r\n            let roledate = await RoleTable.findAll(database._id);\r\n            let arr = [];\r\n            for (let i = 0; i < roledate.length; i++) {\r\n                arr.push(roledate[i]._id);\r\n            }\r\n            data = {\r\n                serverId: 1,\r\n                serverTime: Date.now(),\r\n                roleList: arr,\r\n                code: 1  // 错误码 0失败 1成功-加载场景 2登录太频繁 3IP黑名单 4帐号被禁 5账号在其他地方登陆 6封号 7买卖元宝封号 8不正当竞争封号 9状态不正常 10所有账号登陆都被禁止 11服务器维护\r\n            };\r\n\r\n            session.set({ \"serverId\": 1 })\r\n\r\n\r\n        } else {\r\n            //登录失败\r\n            data = {\r\n                serverId: -1,\r\n                serverTime: 0,\r\n                roleList: [],\r\n                code: 0  // 错误码 0失败 1成功-加载场景 2登录太频繁 3IP黑名单 4帐号被禁 5账号在其他地方登陆 6封号 7买卖元宝封号 8不正当竞争封号 9状态不正常 10所有账号登陆都被禁止 11服务器维护\r\n            };\r\n        }\r\n        next(data);\r\n\r\n    }\r\n}"]}