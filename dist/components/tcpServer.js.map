{"version":3,"file":"tcpServer.js","sourceRoot":"","sources":["../../src/components/tcpServer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * tcp server\r\n */\r\n\r\n\r\nimport * as net from \"net\";\r\nimport { EventEmitter } from \"events\";\r\nimport { SocketProxy } from \"../util/interfaceDefine\";\r\nimport { decode } from \"./msgCoder\";\r\nimport { some_config } from \"../util/define\";\r\nimport { errLog } from \"../LogTS\";\r\n\r\n\r\nexport default function tcpServer(port: number, noDelay: boolean, startCb: () => void, newClientCb: (socket: SocketProxy) => void) {\r\n    let svr = net.createServer(function (socket) {\r\n        socket.setNoDelay(noDelay);\r\n        newClientCb(new NetSocket(socket));\r\n    }).listen(port, startCb);\r\n\r\n    svr.on(\"error\", (err) => {\r\n        errLog(\"error\", err);\r\n        process.exit();\r\n    });\r\n    svr.on(\"close\", () => { });\r\n}\r\n\r\nclass NetSocket extends EventEmitter implements SocketProxy {\r\n    die: boolean = false;\r\n    remoteAddress: string = \"\";\r\n    socket: net.Socket;\r\n    maxLen: number;\r\n    len: number = 0;\r\n    buffer: Buffer = null as any;\r\n    headLen = 0;\r\n    headBuf = Buffer.alloc(4);\r\n    private onDataFunc: (data: Buffer) => void = null as any;\r\n\r\n    constructor(socket: net.Socket) {\r\n        super();\r\n        this.socket = socket;\r\n        this.maxLen = some_config.SocketBufferMaxLenUnregister;\r\n        this.remoteAddress = socket.remoteAddress as string;\r\n\r\n        this.socket.on(\"close\", () => {\r\n            this.onClose();\r\n        });\r\n        this.socket.on(\"error\", (err) => {\r\n            this.onClose(err);\r\n        });\r\n\r\n        this.onDataFunc = this.onData.bind(this);\r\n        this.socket.on(\"data\", this.onDataFunc);\r\n\r\n    }\r\n\r\n    private onClose(err?: Error) {\r\n        if (!this.die) {\r\n            this.die = true;\r\n            this.socket.off(\"data\", this.onDataFunc);\r\n            this.emit(\"close\", err);\r\n        }\r\n    }\r\n\r\n    private onData(data: Buffer) {\r\n        decode(this, data);\r\n    }\r\n\r\n\r\n    send(data: Buffer) {\r\n        this.socket.write(data);\r\n    }\r\n\r\n    close() {\r\n        this.socket.end(() => {\r\n            setTimeout(() => {\r\n                this.socket.destroy();\r\n            }, 1000)\r\n        });\r\n        this.socket.emit(\"close\");\r\n    }\r\n}"]}