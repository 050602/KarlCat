{"version":3,"file":"tcpClient.js","sourceRoot":"","sources":["../../src/components/tcpClient.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * tcp client\r\n */\r\n\r\n\r\nimport * as net from \"net\";\r\nimport { EventEmitter } from \"events\";\r\nimport { SocketProxy } from \"../util/interfaceDefine\";\r\nimport { decode } from \"./msgCoder\";\r\nimport { app, isDebug } from \"../app\";\r\n\r\nexport class TcpClient extends EventEmitter implements SocketProxy {\r\n    die: boolean = false;\r\n    remoteAddress: string = \"\";\r\n    remotePort:number = 0;\r\n    socket: net.Socket;\r\n    maxLen: number;\r\n    len: number = 0;\r\n    buffer: Buffer = null as any;\r\n    headLen = 0;\r\n    headBuf = Buffer.alloc(4);\r\n    private onDataFunc: (data: Buffer) => void = null as any;\r\n\r\n    constructor(port: number, host: string, maxLen: number, noDelay: boolean, connectCb: () => void) {\r\n        super();\r\n        this.socket = net.connect(port, host, () => {\r\n            this.remoteAddress = this.socket.remoteAddress as string;\r\n            this.remotePort = port;\r\n            connectCb();\r\n        });\r\n        this.socket.setNoDelay(noDelay);\r\n        this.maxLen = maxLen;\r\n\r\n        this.socket.on(\"close\", () => {\r\n            this.onClose();\r\n        });\r\n        this.socket.on(\"error\", (err) => {\r\n            this.onClose(err);\r\n        });\r\n\r\n        this.onDataFunc = this.onData.bind(this);\r\n        this.socket.on(\"data\", this.onDataFunc);\r\n    }\r\n\r\n    private onClose(err?: Error) {\r\n        if (!this.die) {\r\n            this.die = true;\r\n            this.socket.off(\"data\", this.onDataFunc);\r\n            this.emit(\"close\", err);\r\n        }\r\n    }\r\n\r\n    private onData(data: Buffer) {\r\n        decode(this, data);\r\n    }\r\n\r\n    send(data: Buffer) {\r\n        this.socket.write(data);\r\n        if (isDebug) {\r\n            if (data.length > this.maxLen) {\r\n                //容错，避免自己杀自己\r\n                if (this.remoteAddress == \"127.0.0.1\") {\r\n                    console.error(app.serverName + \" send is longer then \" + this.maxLen + \" , nowlen : \" + data.length + \", from \" + this.remoteAddress + \" not close it\");\r\n                    return;\r\n                }\r\n                console.error(app.serverName + \" send is longer then \" + this.maxLen + \" , nowlen : \" + data.length + \", close it, \" + this.remoteAddress);\r\n                return;\r\n            }\r\n\r\n            if (this.len > this.maxLen) {\r\n                //容错，避免自己杀自己\r\n                if (this.remoteAddress == \"127.0.0.1\") {\r\n                    console.error(app.serverName + \" send is longer then \" + this.maxLen + \" , nowlen : \" + this.len + \", from \" + this.remoteAddress + \" not close it\");\r\n                    return;\r\n                }\r\n                console.error(app.serverName + \" send is longer then \" + this.maxLen + \" , nowlen : \" + this.len + \", close it, \" + this.remoteAddress);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    close() {\r\n        this.socket.end(() => {\r\n            setTimeout(() => {\r\n                this.socket.destroy();\r\n            }, 1000)\r\n        });\r\n        this.socket.emit(\"close\");\r\n    }\r\n}"]}