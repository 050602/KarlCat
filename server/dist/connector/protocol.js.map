{"version":3,"file":"protocol.js","sourceRoot":"","sources":["../../src/connector/protocol.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AACA,yDAAmD;AACnD,sDAAmD;AACnD,uDAAyC;AAGzC,iBAAiB;AACN,QAAA,oBAAoB,GAAmC;IAC9D,aAAa,EAAE,UAAU,IAAY;QACjC,IAAI,OAAO,GAAW,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;QAC3C,IAAI,MAAM,GAAW,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;QACtC,OAAO;YACH,KAAK,EAAE,OAAO;YACd,KAAK,EAAE,MAAM;YACb,KAAK,EAAE,IAAI;SACd,CAAA;IACL,CAAC;IACD,WAAW,EAAE,UAAU,GAAW,EAAE,GAAW;QAC3C,IAAI,MAAM,GAAG,yBAAW,CAAC,QAAQ,CAAC,KAAK,CAAC;QACxC,IAAI,CAAC,GAAG,gBAAK,CAAC;QACd,IAAI,IAAI,GAAG,IAAI,GAAG,GAAG,CAAC;QACtB,IAAI,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC;QACvB,IAAI,CAAC,GAAG,EAAE;YACN,OAAO,CAAC,KAAK,CAAC,kBAAkB,EAAE,GAAG,CAAC,CAAC;YACvC,OAAO,IAAI,CAAC;SACf;QACD,IAAI,UAAU,GAAQ,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAEtC,OAAO,UAAU,CAAC;IACtB,CAAC;IACD,aAAa,EAAE,UAAU,GAAW,EAAE,GAAQ;QAC1C,IAAI,QAAQ,GAAe,4BAAoB,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;QACpE,IAAI,GAAG,GAAG,MAAM,CAAC,WAAW,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC;QAClD,GAAG,CAAC,aAAa,CAAC,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC,CAAc,yFAAyF;QACjJ,GAAG,CAAC,UAAU,sCAA8B,CAAC,CAAC,CAAC,CAAC,cAAc;QAC9D,GAAG,CAAC,aAAa,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;QAC1B,gCAAgC;QAChC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAE,gCAAgC;QACrE,+BAA+B;QAE/B,IAAI,GAAG,CAAC,MAAM,GAAG,MAAM,CAAC,WAAW,CAAC,kBAAkB,EAAE;YACpD,OAAO,CAAC,KAAK,CAAC,wBAAwB,GAAG,MAAM,CAAC,WAAW,CAAC,kBAAkB,GAAG,cAAc,GAAG,GAAG,CAAC,MAAM,CAAC,CAAC;SACjH;QACD,OAAO,GAAG,CAAC;IACf,CAAC;IACD,WAAW,EAAE,UAAU,GAAW,EAAE,GAAQ;QACxC,IAAI,MAAM,GAAG,yBAAW,CAAC,QAAQ,CAAC,KAAK,CAAC;QACxC,IAAI,CAAC,GAAG,gBAAK,CAAC;QACd,IAAI,GAAG,GAAG,MAAM,CAAC,IAAI,GAAG,GAAG,CAAC,CAAC;QAC7B,IAAI,CAAC,GAAG,EAAE;YACN,OAAO,CAAC,KAAK,CAAC,kBAAkB,EAAE,GAAG,CAAC,CAAC;YACvC,OAAO,IAAI,CAAC;SACf;QACD,IAAI,UAAU,GAAe,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC;QACtD,IAAI,UAAU,CAAC,MAAM,EAAE;YACnB,OAAO,UAAU,CAAC;SACrB;aAAM;YACH,OAAO,IAAI,CAAC;SACf;IACL,CAAC;CACJ,CAAA","sourcesContent":["\r\nimport { lanlu } from \"../proto/protobuf/proto.js\";\r\nimport { ProtoCenter } from \"../proto/ProtoCenter\";\r\nimport * as define from \"../util/define\";\r\nimport { I_encodeDecodeConfig } from \"../util/interfaceDefine\";\r\n\r\n//该代码是正在使用的解码编码工具\r\nexport let default_encodeDecode: Required<I_encodeDecodeConfig> = {\r\n    \"protoDecode\": function (data: Buffer) {\r\n        let mainKey: number = data.readUInt16BE(1);\r\n        let subBuf: Buffer = data.subarray(3);\r\n        return {\r\n            \"cmd\": mainKey,\r\n            \"msg\": subBuf,\r\n            \"toS\": true\r\n        }\r\n    },\r\n    \"msgDecode\": function (cmd: number, msg: Buffer): any {\r\n        let rlanlu = ProtoCenter.Instance.lanlu;\r\n        let r = lanlu;\r\n        let name = 'Pt' + cmd;\r\n        let obj = rlanlu[name];\r\n        if (!obj) {\r\n            console.error(\"msgDecode 不存在协议：\", cmd);\r\n            return null;\r\n        }\r\n        let decodeData: any = obj.decode(msg);\r\n\r\n        return decodeData;\r\n    },\r\n    \"protoEncode\": function (cmd: number, msg: any): Buffer {\r\n        let msgUint8: Uint8Array = default_encodeDecode.msgEncode(cmd, msg);\r\n        let buf = Buffer.allocUnsafe(msgUint8.length + 7);\r\n        buf.writeUInt32BE(msgUint8.length + 3, 0);              //头4位是 消息长度 加上 MainKey和Sonkey 4位，加上 defindServerToClient.msg 1位  总长度是msgBuf.length + 5 位，\r\n        buf.writeUInt8(define.Server_To_Client.msg, 4); //标记这条消息是自定义消息\r\n        buf.writeUInt16BE(cmd, 5);\r\n        // buf.writeUInt16BE(sonKey, 7);\r\n        Buffer.from(msgUint8).copy(buf, 7);  //buf总长度是 4 + 1 + 2 + 2 = 9位，偏移9\r\n        // logInfo(\"发送字节\", buf.length);\r\n\r\n        if (buf.length > define.some_config.SocketBufferMaxLen) {\r\n            console.error(\" protoEncode 超长度了啊啊啊啊 \" + define.some_config.SocketBufferMaxLen + \" , nowlen : \" + buf.length);\r\n        }\r\n        return buf;\r\n    },\r\n    \"msgEncode\": function (cmd: number, msg: any): Uint8Array {\r\n        let rlanlu = ProtoCenter.Instance.lanlu;\r\n        let r = lanlu;\r\n        let obj = rlanlu['Pt' + cmd];\r\n        if (!obj) {\r\n            console.error(\"msgEecode 不存在协议：\", cmd);\r\n            return null;\r\n        }\r\n        let encodeData: Uint8Array = obj.encode(msg).finish();\r\n        if (encodeData.buffer) {\r\n            return encodeData;\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n}\r\n"]}