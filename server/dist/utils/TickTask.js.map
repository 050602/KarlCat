{"version":3,"file":"TickTask.js","sourceRoot":"","sources":["../../src/utils/TickTask.ts"],"names":[],"mappings":"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","sourcesContent":["import { Sigleton } from \"../core/Sigleton\";\r\nimport { DateUtils } from \"./DateUtils\";\r\n\r\n/**\r\n* 定时任务队列\r\n* @author An\r\n*/\r\nexport class TickTask extends Sigleton {\r\n    private TaskDic: Map<number, any[][]> = new Map(); //Key 时间戳， Value 任务 [上下文，回调方法，参数]\r\n    private queueArr: Array<number> = [];//执行任务的时间戳 队列\r\n\r\n\r\n\r\n    private _pause = false;//是否暂停Tick\r\n    private isRuning = false;//是否运行中\r\n\r\n    public static get Instance(): TickTask {\r\n        return this.getInstance();\r\n    }\r\n\r\n    private _time: NodeJS.Timer;\r\n    /**\r\n     * 定时队列\r\n     * 队列里执行方法的对象,理论上不应被销毁\r\n     */\r\n    public initInstance() {\r\n        super.initInstance();\r\n    };\r\n\r\n    public pauseSchedule() {\r\n        this._pause = true;\r\n    }\r\n\r\n    public resumeSchedule() {\r\n        this._pause = false;\r\n    }\r\n\r\n    public destoryInstance() {\r\n        this.isRuning = false;\r\n        this.TaskDic.clear();\r\n        this.queueArr = [];\r\n        // TimerTS.Instance.clear(this, this.update);\r\n        if (this._time) {\r\n            clearInterval(this._time);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 增加新的定时任务到队列\r\n     * @param timestamp 需要执行的具体时间戳，单位毫秒\r\n     * @param callback 回调执行的方法\r\n     * @param data 回调参数\r\n     */\r\n    public pushTask(thisObj: any, callback: Function, timestamp: number, ...data: any[]) {\r\n        if (thisObj == null || callback == null) {\r\n            // gzalog(\"定时执行的方法不能为空\");\r\n            console.error(\"定时执行的对象/方法不能为空\");\r\n            return false;\r\n        }\r\n\r\n        //任务已过期\r\n        if (isNaN(timestamp) || timestamp < DateUtils.timestamp()) {\r\n            console.error(\"时间戳非法/该任务已过期\", timestamp, DateUtils.timestamp());\r\n\r\n            // let date = new Date();\r\n            // date.setTime(timestamp);\r\n            // gzalog(\"传入时间戳\", date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());\r\n            // date.setTime(this._timestamp);\r\n            // gzalog(\"当前时间戳\", date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());\r\n            return false;\r\n        }\r\n\r\n        if (typeof (timestamp) != \"number\") {\r\n            timestamp = parseInt(timestamp);\r\n            console.error(\"时间戳是一个字符串，请注意\", timestamp);\r\n        }\r\n\r\n        let newarr = [];\r\n        newarr.push(thisObj);\r\n        newarr.push(callback);\r\n        newarr.push(data);\r\n\r\n        console.error(\"pushTask\", newarr, timestamp, DateUtils.formatFullTime4(timestamp));\r\n\r\n        //从字典获取该时间戳是否存在任务队列\r\n        let arr = this.TaskDic.get(timestamp);\r\n        if (!arr) {\r\n            arr = [];\r\n            //没有的话，set一个，把时间戳放到 时间戳队列里\r\n            this.queueArr.push(timestamp);\r\n            //执行时间戳排序\r\n            this.arrDichotomy(this.queueArr);\r\n            //根据时间戳存放队列任务数组\r\n            this.TaskDic.set(timestamp, arr);\r\n        }\r\n\r\n        //把任务 推进任务数组\r\n        arr.push(newarr);\r\n\r\n        //当前没有在运行的定时器时，起一个定时器\r\n        if (!this.isRuning) {\r\n            this._time = setInterval(() => {\r\n                this.update();\r\n            }, 1000);\r\n            this.isRuning = true;\r\n        }\r\n\r\n        return true;\r\n\r\n    }\r\n\r\n    /**\r\n     * 移除指定任务\r\n     * @param timestamp \r\n     * @param func\r\n     */\r\n    public removeTask(thisObj: any, func: Function, timestamp: number) {\r\n        let arr: Array<any> = this.TaskDic.get(timestamp);\r\n        if (arr) {\r\n            for (let i = 0; i < arr.length; i++) {\r\n                let obj = arr[i][0];\r\n                let func2 = arr[i][1];\r\n                // let cont2 = dic[i][2];\r\n\r\n                if (thisObj == obj && func2 == func) {\r\n                    console.error(\"removeTask\", timestamp, arr[i]);\r\n                    arr.splice(i, 1);\r\n                    i--;\r\n                }\r\n            }\r\n\r\n            if (arr.length == 0) {\r\n                this.TaskDic.delete(timestamp);\r\n                let index = this.queueArr.indexOf(timestamp);\r\n                if (index != -1) {\r\n                    this.queueArr.splice(index, 1);\r\n                }\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n\r\n    public hasTask(thisObj: any, func: Function, timestamp: number) {\r\n        let arr: Array<any> = this.TaskDic.get(timestamp);\r\n        if (arr) {\r\n            for (let i = 0; i < arr.length; i++) {\r\n                let obj = arr[i][0];\r\n                let func2 = arr[i][1];\r\n\r\n                if (thisObj == obj && func2 == func) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    private update() {\r\n        // LOG(\"UpdateNow\");\r\n        /**暂停 */\r\n        if (this._pause) {\r\n            return;\r\n        }\r\n\r\n        /**servertime == 0 */\r\n        // if (this._timestamp == 0) {\r\n        //     // gzalog(\"未设置时间戳，时间戳非法，请重新设置服务器时间再pushTask\");\r\n        //     return;\r\n        // }\r\n\r\n        if (this.queueArr.length > 0) {\r\n            let curServerTime = DateUtils.timestamp();\r\n            this.checkTask(this.queueArr[0], curServerTime);\r\n        }\r\n    }\r\n\r\n    private checkTask(taskTime: number, curServerTime: number) {\r\n        // LOG(\"checkTask\", this.queueArr);\r\n        //从时间戳队列里取出最前面的时间戳\r\n        if (this.queueArr.length > 0) {\r\n            // let second = this.queueArr[0];\r\n            // if (second != 84600000000)\r\n            // logTest(\"checkTask2\", curServerTime, second);\r\n            // 如果当前时间大于任务队列时间戳，则开始执行 对应时间戳的 任务队列数组\r\n            if (curServerTime > taskTime) {\r\n                let arr = this.TaskDic.get(taskTime);\r\n                if (arr) {\r\n                    console.error(\"doTask\", curServerTime, taskTime, this.queueArr[0]);\r\n                    this.queueArr.splice(0, 1);\r\n                    for (let key in arr) {\r\n                        let element = arr[key];\r\n                        console.error(\"doTask Func\", element);\r\n                        let thisObj: Function = element[0];\r\n                        let func: Function = element[1];\r\n                        let data = element[2];\r\n                        if (func) {\r\n                            try {\r\n                                // logServer(\"check\", thisObj, func);\r\n                                if (data) {\r\n                                    func.apply(thisObj, data);\r\n                                } else {\r\n                                    func.apply(thisObj);\r\n                                }\r\n                            } catch (error) {\r\n                                console.error(\"致命错误,TickTask执行的方法里存在错误\", taskTime, \"\\n\", error);\r\n                            }\r\n                        }\r\n                    }\r\n                    arr = null;\r\n                }\r\n                this.TaskDic.delete(taskTime);\r\n                console.error(\"checkTaskRemoveTask\", curServerTime, taskTime);\r\n                if (this.queueArr.length > 0) {\r\n                    this.checkTask(this.queueArr[0], curServerTime);\r\n                }\r\n            }\r\n        } else {\r\n            //当发现无可执行任务时，自行销毁\r\n            clearInterval(this._time);\r\n            this.isRuning = false;\r\n        }\r\n    }\r\n\r\n\r\n    //二分法排序\r\n    public arrDichotomy(array: any[]) {\r\n        for (let i = 0; i < array.length; i++) {\r\n            let temp = array[i];//待插入到前面有序序列的值\r\n            let left = 0;//有序序列的左侧\r\n            let right = i - 1;//有序序列的右侧\r\n            let middle = 0;//有序序列的中间\r\n            while (left <= right) {\r\n                middle = Math.floor((left + right) / 2);//赋值\r\n                middle = (left + right) >> 1;//赋值\r\n                if (temp < array[middle]) {\r\n                    right = middle - 1;\r\n                } else {\r\n                    left = middle + 1;\r\n                }\r\n            }\r\n            for (let j = i - 1; j >= left; j--) {\r\n                //从i-1到left依次向后移动一位,等待temp值插入\r\n                array[j + 1] = array[j];\r\n            }\r\n            if (left != i) {\r\n                array[left] = temp;\r\n            }\r\n        }\r\n        return array;\r\n    }\r\n}"]}